---
title: "Fatalities EDA 1"
author: "Christina De Cesaris"
date: "2/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries}
library(tidyverse)
library(dplyr)
library(AER)
library(agricolae)

```

# Load and clean data
```{r Load Data}
data(Fatalities)
head(Fatalities)

str(Fatalities) 

dim(Fatalities) #336 x 34

which(is.na(Fatalities)) #4732, 5068
apply(is.na(Fatalities), 2, which) #missing data at jail: row 28, service: row 28

Fatalities[28,] #consider dropping 28.
#yeah let's drop it

Fatalities = drop_na(Fatalities)

dim(Fatalities) #335 x 34
```

# Wrangling/playing around
Trying different things to make new datasets and metric for predictions

```{r}
cor(Fatalities[sapply(Fatalities, is.numeric)])
```

## 
**Some features**

- unemp: unemployment rate
- emppop: employment population ratio
- beertax: tax on case of beer
- drinkage: minimal legal drinking age
- youngdrivers: percent of drivers 14-24
- miles: avg miles per driver
- jail: mandatory jail sentence? y/n
- service: mandatory community service
- fatal: number of vehical fatalities
- fatal@@##: represents the number of vehical fatalities from ages @@-##
- afatal: alcohol-involved vehical fatalities
- pop: population total
- pop@@##: represents the number of people from ages @@-##
- spirits: spirit consumption
- year: year
- state: state

```{r}
#head(Fatalities)

afatal_fatal = Fatalities
afatal_fatal$afatal_ratio= afatal_fatal$afatal/afatal_fatal$fatal #creates a ratio for each instance of alchol related veh fatalties/ total veh fatalities

afatal_fatal$unemp_ratio= afatal_fatal$unemp/afatal_fatal$unempus #creates a ratio for each instance of numeric. Unemployment rate./ US unemployment/population ratio.


afatal_fatal$emp_ratio= afatal_fatal$emppop/afatal_fatal$emppopus #creates a ratio for each instance of numeric. (Employment/population ratio)/ (US employment/population ratio
```

```{r}


jail_sum=afatal_fatal%>%group_by(state,jail) %>%
  summarize(mean_drinkage = signif(mean(drinkage, na.rm = TRUE), digits=5), mean_afatal_ratio= signif(mean(afatal_ratio, na.rm = TRUE), digits=5)) #Mean drinking age across states


breath_sum=afatal_fatal%>%group_by(state,breath) %>%
  summarize(mean_drinkage = signif(mean(drinkage, na.rm = TRUE), digits=5), mean_afatal_ratio= signif(mean(afatal_ratio, na.rm = TRUE), digits=5))

service_sum=afatal_fatal%>%group_by(state,service) %>%
  summarize(mean_drinkage = signif(mean(drinkage, na.rm = TRUE), digits=5), mean_afatal_ratio= signif(mean(afatal_ratio, na.rm = TRUE), digits=5))
```

```{r}
(afatal_fatal) #note an umemp_ratio >1 means this for this year, this state has exceeded the total us unemployment rate

#afatal ratio cannot exceed 1 because it is the ratio for that state, for that year of the amount of alcohol related veh deaths/total veh deaths
```


```{r Unemployment ratio box plot, fig.width=15}

ggplot(afatal_fatal, aes(factor(state), unemp_ratio, fill=factor(state))) + geom_boxplot()+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=15, hjust=1),axis.ticks.x = element_line(size=0.5))

```


```{r Basic Box plot showing the spread of afatal/population size, fig.width=15}
#ratio of alchol related vehicle fatalities/ population~~over the span of study years

ggplot(afatal_fatal, aes(factor(state), afatal_ratio, fill=factor(state))) + geom_boxplot()+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=15, hjust=1),axis.ticks.x = element_line(size=0.5))

#
```
```{r Basic Box plot showing the spread of afatal/carfatalities size, fig.width=15}

#This is a RATIO of Alcohol related vehical fatalites/ all vehical fatalities
ggplot(afatal_fatal, aes(factor(state), afatal/fatal, fill=factor(state))) + geom_boxplot()+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=15, hjust=1),axis.ticks.x = element_line(size=0.5))

#
```



## Models
```{r One-Way factor models}
#One way anova mean-alchol fatality ratio on factor(jail)
anova.jail = aov(mean_afatal_ratio~factor(jail),jail_sum)
summary(anova.jail) #a difference across ratios for state,
anova.jail$coef #having jail as yes increases the predicted


#One way anova mean-alchol fatality ratio on factor(breath)
anova.breath = aov(mean_afatal_ratio~factor(breath),breath_sum)
summary(anova.breath) #a difference across ratios for state,
anova.breath$coef #having breath as yes decreases the predicted?

#One way anova mean-alchol fatality ratio on factor(service)
anova.service = aov(mean_afatal_ratio~factor(service),service_sum)
summary(anova.service) #a difference across ratios for state,
anova.service$coef #having service as yes decreases the predicted?
```
```{r}

```



```{r, some factorial linear models}
#head(afatal_fatal)
mod_states = lm(afatal_ratio~factor(state),afatal_fatal)
mod_states
summary(mod_states) #interesting but not very telling


mod_beertax = lm(afatal_ratio~beertax,afatal_fatal)
mod_beertax
summary(mod_beertax) #not great model

mod_statebeer= lm(afatal_ratio~beertax*factor(state),afatal_fatal)
mod_statebeer
summary(mod_statebeer)#not great either
```

```{r}
#transformations
hist(afatal_fatal$afatal_ratio)#skewws right
hist(log(afatal_fatal$afatal_ratio))#better

hist(afatal_fatal$afatal)

hist(afatal_fatal$beertax) 
```

```{r}
mod2=lm(afatal_ratio~ beertax+drinkage, afatal_fatal)

mod2 #increased drinking age causes a decrease in our ratio

par(mfrow-c(2,2))
plot(mod2)
```


## Feature selection fun

**Normally use a training testing set!!!**
```{r}
#afatal_fatal
sub_ratio=afatal_fatal[, !(colnames(afatal_fatal) %in% c("fatal","afatal","emppop","emppopus","baptist","mormon"))]#drop these cols to avoid multicolinearity, drop religions here as well


none_mod = lm(log(afatal_ratio)~1, data=sub_ratio) 
full_mod = lm(log(afatal_ratio)~., data=sub_ratio)  
library(MASS)
#summary(full_mod)
#forward selection based on AIC: 
lm.step=stepAIC(none_mod, scope=list(upper=full_mod, lower = ~1), direction="both", k=2, trace = FALSE)
lm.step

```


```{r}
summary(lm.step)
par(mfrow=c(2,2))
plot(lm.step)
```
```{r}
plot(lm.step,which=2) #transformation might be needed yo
plot(lm.step,which=4) #149 causing a mess
```


## Extra model investigation

```{r}
mod2=lm(formula = log(afatal_ratio) ~ state + sfatal + income + emp_ratio + 
    factor(jail) + factor(service) + fatal1517 + miles, data = sub_ratio)


summary(mod2)
```



