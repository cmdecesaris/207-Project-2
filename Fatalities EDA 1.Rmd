---
title: "Fatalities EDA 1"
author: "Christina De Cesaris"
date: "2/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(dplyr)
library(AER)
library(agricolae)
library(car)
library(DT)
```


```{r Load Data, include=FALSE}
# Load and clean data
data(Fatalities)
head(Fatalities)

str(Fatalities) 

dim(Fatalities) #336 x 34

which(is.na(Fatalities)) #4732, 5068
apply(is.na(Fatalities), 2, which) #missing data at jail: row 28, service: row 28

Fatalities[28,] #consider dropping 28.
#yeah let's drop it

Fatalities = drop_na(Fatalities)

dim(Fatalities) #335 x 34
```

```{r Add Ratios, include=FALSE}
#head(Fatalities)

afatal_fatal = Fatalities
afatal_fatal$af_ratio= (afatal_fatal$afatal/afatal_fatal$fatal) #creates a ratio for each instance of alcohol related  fatalities/ total fatalities per 100k people

afatal_fatal$ap_ratio= (afatal_fatal$afatal/afatal_fatal$pop)*100000 #per 100k people
afatal_fatal
```



```{r Final Predicting Set,include=FALSE}
af=afatal_fatal %>%dplyr::select(state,year,miles,jail,breath,service,af_ratio,ap_ratio) 

af


af_state=af%>% group_by(state,jail,service,breath)%>%summarize(mean_af = mean(af_ratio), mean_ap=mean(ap_ratio))
af_state
af
af_state_graph=af%>% group_by(state,jail)%>%summarize(mean_af = mean(af_ratio), mean_ap=mean(ap_ratio))


yes_no
af%>%filter(year=='1983'&jail=='yes')%>%summarize(mean(ap_ratio))



af_year=af%>% group_by(year,jail,service,breath)%>%summarize(mean_af = mean(af_ratio), mean_ap=mean(ap_ratio))
af_year_graph=af%>% group_by(year,jail)%>%summarize(mean_af = mean(af_ratio), mean_ap=mean(ap_ratio))

af_year_graph

af %>% group_by(state,jail,service, breath)%>% 
  count(state, jail) %>% rename(Total_Jail= n)

af %>% group_by(state,service)%>% 
  count(state, service) %>% rename(Total_Service= n)

tot_jail_year=af %>% group_by(year,jail)%>% 
  count(year, jail) %>% rename(Total_Jail= n)

tot_serv_year=af %>% group_by(year,service)%>% 
  count(year, service) %>% rename(Total_Service= n)



af_yearx=merge(tot_jail_year,af_year)
af_year


```

```{r, Visualization of Set}

datatable(af,class = 'cell-border stripe', 
 caption = htmltools::tags$caption(
    style = 'caption-side: bottom; text-align: center;',
    'Table X: ', htmltools::em('XXXXX')), colnames= )


datatable(af_year,class = 'cell-border stripe', 
 caption = htmltools::tags$caption(
    style = 'caption-side: bottom; text-align: center;',
    'Table X: ', htmltools::em('XXXXX')), colnames= )


datatable(af_state,class = 'cell-border stripe', 
 caption = htmltools::tags$caption(
    style = 'caption-side: bottom; text-align: center;',
    'Table X: ', htmltools::em('XXXXX')), colnames= )
```

```{r State Lolipops, fig.width=15}

ggplot(af_state_graph, aes(factor(state), mean_af )) + geom_point(aes(color = factor(jail)),size=3 )+labs(x="State", y="Mean Alcohol Fatalities/Fatalities",  
       col="Jail Sentence?",title="Mean Alcohol Fatalities/Fatalities by State")+  scale_color_manual(labels = c("No", "Yes"), values = c("red", "green"))+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=75, hjust=1),axis.ticks.x = element_line(size=0.5))+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+ geom_line()




ggplot(af_state_graph, aes(factor(state), mean_ap )) + geom_point(aes(color = factor(jail)),size=3 )+labs(x="State", y="Mean Alcohol Fatalities/Pop by State",  
       col="Jail Sentence?",title="Mean Alcohol Fatalities/Pop by Jail")+  scale_color_manual(labels = c("No", "Yes"), values = c("red", "green"))+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=75, hjust=1),axis.ticks.x = element_line(size=0.5))+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+ geom_line()
```

```{r Year Lolipops, fig.width=15}

ggplot(a, aes(factor(state), ap_ratio )) + geom_point(aes(shape = factor(jail),color=factor(year)),size=3 )+labs(x="State", y="Mean Alcohol Fatalities/Fatalities",  
       col="Jail Sentence?",title="Mean Alcohol Fatalities/Fatalities by State")+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=75, hjust=1),axis.ticks.x = element_line(size=0.5))+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+ geom_line()


af_year_graph

ggplot(a, aes(factor(year), ap_ratio )) + geom_point(aes(shape = factor(jail),color=factor(state)),size=3 )+labs(x="Year", y="Mean Alcohol Fatalities/Pop by Jail Status",  
       col="Jail Sentence?",title="Mean Alcohol Fatalities/Pop by Year per 10k")+  theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=75, hjust=1),axis.ticks.x = element_line(size=0.5))+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+ geom_line()
```
```{r}

ggplot(af, aes(factor(state), ap_ratio )) + geom_point(aes(shape = factor(jail),color=factor(year)),size=3 )+labs(x="State", y="Mean Alcohol Fatalities/Fatalities",  
       col="Jail Sentence?",title="Mean Alcohol Fatalities/Fatalities by State")+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=75, hjust=1),axis.ticks.x = element_line(size=0.5))+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+ geom_line()




ggplot(b, aes(factor(year), ap_ratio )) + geom_point(aes(shape = factor(jail),color=factor(state)),size=3 )+labs(x="Year", y="Mean Alcohol Fatalities/Pop by Jail Status",  
       col="Jail Sentence?",title="Mean Alcohol Fatalities/Pop by Year per 10k")+  theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=75, hjust=1),axis.ticks.x = element_line(size=0.5))+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+ geom_line()
```













```{r Basic Box plot showing the spread of afatal/carfatalities size, fig.width=15}

#This is a RATIO of Alcohol related vehical fatalites/ all vehical fatalities
ggplot(afatal_fatal, aes(factor(state), afatal/fatal, fill=factor(state))) + geom_boxplot()+scale_x_discrete(guide = guide_axis(n.dodge = 1),expand=c(0, 0))+theme(text = element_text(size=14,face = 'bold'),
        axis.text.x = element_text(angle=15, hjust=1),axis.ticks.x = element_line(size=0.5))

#
```
```{r Transformations}
#transformations
hist(af$af_ratio)#skewws right
hist(log(af$af_ratio))#better

hist(af$ap_ratio)#skewws right
hist(log(af$ap_ratio))#better

hist(af_year$mean_ap)
hist(af_year$mean_af)
```




## Models

To assess whether state implemented laws had a significant effect on alcohol related vehicle fatalities, we first must subset our data. It is unrealistic to expect the demographic and political priorities of each state is equivalent. In a attempt to address this discrepancy, we have decided to investigate the effectiveness of jail, service, and breath laws in the Southern and North Eastern regions of the united states. 

In the case of this model, it is important to recognize the factorial variables jail and service indicate whether a first-time drunk driving offense leads to subsequent jail time or mandatory community service. 



```{r}
south= af%>%filter(state %in% c("la","ms","al","ga","sc","ar","tx","fl","nc","tn","ar","ok","ky","wv","va"))


n_east= af%>%filter(state %in% c("me","vt","nh","ma","ny","ri","ct","nj","de","md","pa"))

```



```{r Using Ratios for Each Combo + Interactions}

anova.k = lm(log(ap_ratio)~factor(state)+factor(year)
+factor(jail)+factor(breath)+factor(service)+miles
,south)
anova(anova.k)
summary(anova.k)
anova.k$coef
plot(anova.k)

anova.ki = lm((log(ap_ratio))~factor(state)+factor(year)+miles+
factor(jail)*factor(service)*factor(breath),south)
summary(anova.ki)
anova(anova.ki)
anova.ki$coef
plot(anova.ki)

anova.k = lm(log(ap_ratio)~factor(state)+(year)
+factor(jail)+factor(breath)+factor(service)
+miles
,n_east)
anova(anova.k)
summary(anova.k)
anova.k$coef
plot(anova.k)

anova.ki = lm((log(ap_ratio))~factor(state)+factor(year)+factor(jail)*factor(service)*factor(breath),n_east)
summary(anova.ki)
anova.ki$coef
anova(anova.ki)
plot(anova.ki)
```




```{r Interactions Significant?}

```
















